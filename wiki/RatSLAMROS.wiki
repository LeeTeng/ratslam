#labels RatSLAM,ROS
The ROS version of RatSLAM has been designed as a more modular version than the other library in this project - the algorithm has been divided into 3 individual RatSLAM ROS nodes and one visual odometry node.

This version of RatSLAM was based on the RatSLAM C++ library written by David Ball and Scott Heath, with support and additions by Michael Milford. The RatSLAM algorithm was originally designed and implemented by Michael Milford and Gordon Wyeth.

The ROS version of RatSLAM has only been tested on Ubuntu and as ROS support for platforms other than Linux is still limited, this will probably not change.

For a full description of ROS terminology have a look [http://www.ros.org here]. 

==Dependencies==

The ROS version of RatSLAM depends on ROS dependencies:
opencv2 and topological_nav_msgs
and also on [http://irrlicht.sourceforge.net Irrlicht]
Irrlicht may be installed on Ubuntu with apt-get
{{{
sudo apt-get install libirrlicht-dev
}}}

==Build Instructions==

Checkout the source from svn:

{{{
svn checkout http://ratslam.googlecode.com/svn/branches/ratslam_ros ratslam_ros
}}}

Setup ROS environment variables by typing something like:
{{{
. /opt/ros/diamondback/setup.sh
}}}

Make sure ratslam_ros is in a directory on the environment variable ROS_PACKAGE_PATH

Then build ratslam_ros with
{{{
rosmake
}}}

==Running RatSLAM==

To use one of our pre-packaged bag files, download the bag file for either:
 * iRat in Aus
 * Car in St Lucia

both are available [https://wiki.qut.edu.au/display/cyphy/OpenRatSLAM+datasets here]

and place the dataset in the ratslam_ros directory.

Run the dataset and RatSLAM by typing either
{{{
roslaunch irataus.launch
rosbag play irat_aus_28112011.bag
}}}
or
{{{
roslaunch stlucia.launch
rosbag play stlucia_2007.bag
}}}

===Using Custom Bag Files (or Real Robots)===

Bag files (or real robots) must provide at least images for RatSLAM on topics /`<`topic_root`>`/camera/image `[sensor_msgs::Image]` or /`<`topic_root`>`/camera/image/compressed `[sensor_msgs::CompressedImage]` (refer to [ROS image transport http://www.ros.org/wiki/image_transport]). 
Odometry may also be provided on topic /`<`topic_root`>`/odom `[nav_msgs::Odometry]`, or can be estimated using visual flow from the image data.
Aside from the bag file, two other files are required: a config file and a launch file. An example config file is shown below (used for the St. Lucia data set):
{{{
[general]
topic_root=stlucia
                                                	
[ratslam]
image_crop_x_min=40
image_crop_x_max=600
image_crop_y_min=150
image_crop_y_max=300
vt_match_threshold = 0.085
template_x_size=60
template_y_size=10
vt_shift_match = 5
vt_step_match = 1
vt_normalisation = 0.4
pc_vt_restore=0.04

pc_cell_x_size = 2
pc_dim_xy = 30
exp_delta_pc_threshold = 1.0
pc_vt_inject_energy = 0.15
vt_active_decay = 1.0

exp_loops=20


[visual_odometry]
vtrans_image_x_min=195
vtrans_image_x_max=475
vtrans_image_y_min=270
vtrans_image_y_max=430

vrot_image_x_min=195
vrot_image_x_max=475
vrot_image_y_min=75
vrot_image_y_max=240

camera_fov_deg=53
camera_hz = 10
vtrans_scaling = 1000
vtrans_max=20

[draw]
enable=1
vt_window_width=640
vt_window_height=900
exp_map_size=500
posecells_size=250
media_path=../src/media
image_file=irat_sm.tga
}}}

The topic_root in a config file may be set to any value as long as it matches the `<`topic_root`>` paths specified in the bag file. The config file also contains RatSLAM options, visual odometry options and drawing options.

The launch file specifies which nodes of RatSLAM should be run and which config file to use. An example launch file is shown below(also used for the St. Lucia dataset):
{{{

<launch>

	<machine name="local_alt" address="localhost" default="true" />
	
	<node name="RatSLAMLocalViewCells" pkg="ratslam_ros" type="ratslam_lv" args="../config/config_stlucia.txt _image_transport:=compressed" cwd="node" required="true" />
	<node name="RatSLAMPoseCells" pkg="ratslam_ros" type="ratslam_pc" args="../config/config_stlucia.txt _image_transport:=compressed" cwd="node" required="true" />
	<node name="RatSLAMExperienceMap" pkg="ratslam_ros" type="ratslam_em" args="../config/config_stlucia.txt _image_transport:=compressed" cwd="node" required="true" />
	<node name="RatSLAMVisualOdometry" pkg="ratslam_ros" type="ratslam_vo" args="../config/config_stlucia.txt _image_transport:=compressed" cwd="node" required="true" />
	
	<node pkg="rxtools" type="rxplot" name="plot_vt_em" args="-b -1 -p 500 -r 1 -m . /stlucia/LocalView/Template/current_id,/stlucia/PoseCell/TopologicalAction/dest_id" />
	<node pkg="rosbag" type="record" name="record" args="/stlucia/ExperienceMap/Map /stlucia/ExperienceMap/RobotPose /stlucia/LocalView/Template /stlucia/PoseCell/TopologicalAction -O ratslam_out.bag" />

</launch>
}}}

The config file name must be set to the config file used. The line with:
{{{
	<node name="RatSLAMVisualOdometry" pkg="ratslam_ros" type="ratslam_vo" args="../config/config_stlucia.txt _image_transport:=compressed" cwd="node" required="true" />
}}} 
needs to be commented out if providing odometry.

=== Step by Step ===

*Loading the data into a bag file*

Start recording.
{{{
rosrecord -O <my_robot>.bag <my_robot>/camera/images <my_robot>/odom
}}}
(see [http://www.ros.org/wiki/rosbag/Commandline] for more detail)

Start a robot moving!

Press Ctrl-C at the terminal to finish recording.

*Creating a new config file*

In a terminal type

{{{
cd ratslam_ros
cp config/config_stlucia.txt config/config_<my_robot>.txt
}}}

*Creating a new launch file*

In the same terminal type

{{{
cp stlucia.launch <my_robot>.launch
gedit <my_robot>.launch
}}}

Replace all references to "../config/config_stlucia.txt" with "../config/config_`<`my_robot`>`.txt"

Comment out the visual odometry node to prevent it from running.
Replace
{{{
<node name="RatSLAMVisualOdometry" pkg="ratslam_ros" type="ratslam_vo" args="../config/config_stlucia.txt _image_transport:=compressed" cwd="node" required="true" />
}}}

with 
{{{
<!-- <node name="RatSLAMVisualOdometry" pkg="ratslam_ros" type="ratslam_vo" args="../config/config_stlucia.txt _image_transport:=compressed" cwd="node" required="true" />-->
}}}

*Running your dataset*

Your dataset can now be run the same way is the provided datsets:
{{{
roslaunch <my_robot>.launch
rosbag play <my_robot>.bag
}}}

*Tuning the parameters*
The parameters in the provided config files may work for you ... but they may not.


Open the created config file
{{{
gedit config/config_<my_robot>.txt
}}}

Tweak...